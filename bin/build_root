#!/usr/bin/env php
<?php
use Everyman\Neo4j\Client,
	Everyman\Neo4j\Index\NodeIndex,
	Everyman\Neo4j\Relationship,
	Everyman\Neo4j\Node,
	Everyman\Neo4j\Gremlin,
	Tokenizer\Token;

include_once(dirname(__DIR__).'/library/Autoload.php');
spl_autoload_register('Autoload::autoload_library');

if (in_array('-V', $argv)) {
    define('DISPLAY', false);
} else {
    define('DISPLAY', true);
}

if ($id = array_search('-p', $argv)) {
    $project = $argv[$id + 1];
} else {
    $project = 'None';
}

$begin = microtime(true);
$client = new Client();

$result = query("g.idx('racines')");
if ($result[0][0] != 'MANUAL[racines:Vertex]') {
    query("g.createManualIndex('racines', Vertex)");
}
query("g.V[0..10].has('token', 'INDEX').out('INDEXED').each{ g.idx('racines').put('token', it.token, it); };");
if (DISPLAY) print "Indexing done\n";

query("g.idx('racines')[['token':'S_STRING']].out('INDEXED').filter{it.code.replaceAll(/^['\"]/, '').size() > 0}.each{ it.setProperty('unicode_block', it.code.replaceAll(/^['\"]/, '').toList().groupBy{ Character.UnicodeBlock.of( it as char ).toString() }.sort{-it.value.size}.find{true}.key.toString()); };");

if (DISPLAY) print "String unicode done\n";

$end = microtime(true);

//$db = new Db('exakat');
//$db->query("INSERT INTO build_root (tokens, duration, project) VALUES ('$project', )");

function query($query) {
    global $client;
    $params = array('type' => 'IN');
    try {
        $GremlinQuery = new Gremlin\Query($client, $query, $params);
        return $GremlinQuery->getResultSet();
    } catch (Exception $e) {
        $fp = fopen('log/build_root.log', 'a');
        fwrite($fp, "Sleeping...\n");
        fwrite($fp, $query."\n");
        fclose($fp);
        
        sleep(2);
        query($query);
    }
}

?>